{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Gerenciales - DSSD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .metric-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 2px 0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .content-area {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h5 class="text-white">DSSD Admin</h5>
                        <p class="text-muted small">Bienvenido, {{ user_name }}</p>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'dashboard' %}">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content-area">
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1><i class="fas fa-chart-line me-3"></i>Dashboard de Reportes</h1>
                            <p class="mb-0">Análisis integral del desempeño organizacional</p>
                        </div>
                        <div class="text-end">
                            <small>Última actualización: {{ fecha_actualizacion|date:"d/m/Y H:i" }}</small>
                        </div>
                    </div>
                </div>

                <!-- Métricas Resumen -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="metric-card text-center">
                            <div class="metric-number">{{ metricas.total_proyectos }}</div>
                            <div class="metric-label">Proyectos Activos</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card text-center">
                            <div class="metric-number">{{ metricas.total_compromisos }}</div>
                            <div class="metric-label">Compromisos Totales</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card text-center">
                            <div class="metric-number">{{ metricas.total_observaciones }}</div>
                            <div class="metric-label">Total Observaciones</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card text-center">
                            <div class="metric-number">{{ metricas.total_ongs }}</div>
                            <div class="metric-label">ONGs Registradas</div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos Principales -->
                <div class="row">
                    <!-- Gráfico 1: Progreso de Proyectos -->
                    <div class="col-lg-6 mb-4">
                        <div class="card dashboard-card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-tasks me-2"></i>Progreso de Proyectos por ONG
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="progresoProyectosChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfico 2: Compromisos por ONG -->
                    <div class="col-lg-6 mb-4">
                        <div class="card dashboard-card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-handshake me-2"></i>Compromisos por ONG
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="compromisosChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Gráfico 3: Segmentación de Observaciones por Proyecto -->
                    <div class="col-lg-8 mb-4">
                        <div class="card dashboard-card">
                            <div class="card-header bg-warning text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Segmentación de Observaciones por Proyecto
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="observacionesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla de Eficiencia -->
                    <div class="col-lg-4 mb-4">
                        <div class="card dashboard-card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-trophy me-2"></i>Ranking de Eficiencia
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>ONG</th>
                                                <th>Eficiencia</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ong in eficiencia_ongs|slice:":5" %}
                                            <tr>
                                                <td>
                                                    <small>{{ ong.nombre|truncatechars:20 }}</small>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{% if ong.porcentaje_eficiencia > 80 %}success{% elif ong.porcentaje_eficiencia > 50 %}warning{% else %}danger{% endif %}">
                                                        {{ ong.porcentaje_eficiencia|floatformat:1 }}%
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla Detallada de Proyectos -->
                <div class="row">
                    <div class="col-12">
                        <div class="card dashboard-card">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-table me-2"></i>Detalle de Proyectos
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ONG Originante</th>
                                                <th>Proyecto</th>
                                                <th>Total Etapas</th>
                                                <th>Completadas</th>
                                                <th>Progreso</th>
                                                <th>Observaciones</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for proyecto in proyectos_detalle %}
                                            <tr>
                                                <td>{{ proyecto.ong_originante }}</td>
                                                <td>{{ proyecto.nombre|truncatechars:30 }}</td>
                                                <td class="text-center">{{ proyecto.total_etapas }}</td>
                                                <td class="text-center">{{ proyecto.etapas_completadas }}</td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar bg-{% if proyecto.progreso > 80 %}success{% elif proyecto.progreso > 50 %}warning{% else %}danger{% endif %}" 
                                                             style="width: {{ proyecto.progreso }}%">
                                                            {{ proyecto.progreso|floatformat:0 }}%
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-{% if proyecto.observaciones > 2 %}danger{% elif proyecto.observaciones > 0 %}warning{% else %}success{% endif %}">
                                                        {{ proyecto.observaciones }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{% if proyecto.estado == 'Finalizado' %}success{% elif proyecto.estado == 'Ejecucion' %}primary{% else %}secondary{% endif %}">
                                                        {{ proyecto.estado }}
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Datos del servidor
        const datosProgreso = {{ datos_progreso|safe }};
        const datosCompromisos = {{ datos_compromisos|safe }};
        const datosObservaciones = {{ datos_observaciones|safe }};

        // Gráfico 1: Progreso de Proyectos
        const ctxProgreso = document.getElementById('progresoProyectosChart').getContext('2d');
        new Chart(ctxProgreso, {
            type: 'bar',
            data: {
                labels: datosProgreso.labels,
                datasets: [{
                    label: 'Etapas Completadas',
                    data: datosProgreso.completadas,
                    backgroundColor: '#28a745',
                    borderRadius: 6
                }, {
                    label: 'Etapas Pendientes',
                    data: datosProgreso.pendientes,
                    backgroundColor: '#dc3545',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                const total = datosProgreso.completadas[context.dataIndex] + datosProgreso.pendientes[context.dataIndex];
                                const porcentaje = ((datosProgreso.completadas[context.dataIndex] / total) * 100).toFixed(1);
                                return `Progreso: ${porcentaje}%`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
            }
        });

        // Gráfico 2: Compromisos por ONG
        const ctxCompromisos = document.getElementById('compromisosChart').getContext('2d');
        new Chart(ctxCompromisos, {
            type: 'doughnut',
            data: {
                labels: datosCompromisos.labels,
                datasets: [{
                    data: datosCompromisos.aceptados,
                    backgroundColor: [
                        '#007bff', '#28a745', '#ffc107', '#dc3545', 
                        '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = datosCompromisos.totales[context.dataIndex];
                                const aceptados = context.parsed;
                                const porcentaje = ((aceptados / total) * 100).toFixed(1);
                                return `${context.label}: ${aceptados}/${total} (${porcentaje}%)`;
                            }
                        }
                    }
                }
            }
        });

        // Gráfico 3: Segmentación de Observaciones por Proyecto
        const ctxObservaciones = document.getElementById('observacionesChart').getContext('2d');
        new Chart(ctxObservaciones, {
            type: 'bar',
            data: {
                labels: datosObservaciones.labels,
                datasets: [{
                    label: 'Total de Observaciones',
                    data: datosObservaciones.valores,
                    backgroundColor: [
                        '#ffc107', '#dc3545', '#28a745', '#007bff', 
                        '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
                    ],
                    borderColor: '#fff',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed.y} observaciones`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });

        // Actualizar cada 5 minutos
        setTimeout(() => {
            location.reload();
        }, 300000);
    </script>
</body>
</html>

{% extends 'base.html' %}

{% block title %}Verificar Tarea Ejecutada{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2 class="mb-4">üîç Verificar Datos de Tarea Ejecutada</h2>
            
            {% if error %}
                <div class="alert alert-danger" role="alert">
                    ‚ùå {{ error }}
                </div>
            {% endif %}
            
            {% if success %}
                <div class="alert alert-success" role="alert">
                    ‚úÖ {{ message }}
                </div>
                
                <div class="row">
                    <!-- Informaci√≥n General -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>üìä Informaci√≥n General</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Case ID:</strong> {{ case_id }}</p>
                                <p><strong>Tarea:</strong> {{ task_name }}</p>
                                {% if proyecto %}
                                    <p><strong>Proyecto:</strong> {{ proyecto.nombre }} (ID: {{ proyecto.id }})</p>
                                    <p><strong>Descripci√≥n:</strong> {{ proyecto.descripcion }}</p>
                                    <p><strong>Estado:</strong> {{ proyecto.estado }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumen de Verificaci√≥n -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>‚úÖ Resumen de Verificaci√≥n</h5>
                            </div>
                            <div class="card-body">
                                {% if verificacion %}
                                    <div class="mb-2">
                                        <span class="badge badge-{% if verificacion.variables_found %}success{% else %}warning{% endif %}">
                                            Variables: {% if verificacion.variables_found %}‚úÖ Encontradas{% else %}‚ö†Ô∏è No encontradas{% endif %}
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge badge-{% if verificacion.bdm_updated %}success{% else %}warning{% endif %}">
                                            BDM: {% if verificacion.bdm_updated %}‚úÖ Actualizado{% else %}‚ö†Ô∏è Sin actualizar{% endif %}
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge badge-info">
                                            Pr√≥ximas tareas: {{ verificacion.next_tasks }}
                                        </span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge badge-success">
                                            Tareas completadas: {{ verificacion.completed_tasks }}
                                        </span>
                                    </div>
                                {% else %}
                                    <p class="text-muted">No se pudo realizar la verificaci√≥n completa.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Variables del Proceso -->
                {% if variables_proceso %}
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>üìã Variables del Proceso</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for nombre, valor in variables_proceso.items %}
                                        <tr>
                                            <td><code>{{ nombre }}</code></td>
                                            <td>
                                                {% if valor %}
                                                    {{ valor|truncatechars:100 }}
                                                {% else %}
                                                    <span class="text-muted">null</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Tareas Disponibles -->
                {% if tareas_disponibles %}
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>üìã Estado de Tareas</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th>Display Name</th>
                                            <th>Estado</th>
                                            <th>Asignado a</th>
                                            <th>√öltima Actualizaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tarea in tareas_disponibles %}
                                        <tr class="{% if tarea.state == 'completed' %}table-success{% elif tarea.state == 'ready' %}table-info{% endif %}">
                                            <td>{{ tarea.id }}</td>
                                            <td>{{ tarea.name|default:"-" }}</td>
                                            <td>{{ tarea.displayName|default:"-" }}</td>
                                            <td>
                                                <span class="badge badge-{% if tarea.state == 'ready' %}primary{% elif tarea.state == 'completed' %}success{% else %}secondary{% endif %}">
                                                    {{ tarea.state }}
                                                </span>
                                            </td>
                                            <td>{{ tarea.assigned_id|default:"No asignado" }}</td>
                                            <td>{{ tarea.last_update_date|default:"-" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
            
            <!-- Formulario de Verificaci√≥n -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>üîç Verificar Tarea</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="case_id">Case ID de Bonita:</label>
                            <input type="text" class="form-control" id="case_id" name="case_id" 
                                   value="{{ current_case_id|default:'' }}" 
                                   placeholder="Ingresa el Case ID o se usar√° el de la sesi√≥n">
                            <small class="form-text text-muted">
                                {% if current_case_id %}
                                    Case ID actual en sesi√≥n: {{ current_case_id }}
                                {% else %}
                                    No hay Case ID en la sesi√≥n actual
                                {% endif %}
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="task_name">Nombre de la Tarea:</label>
                            <input type="text" class="form-control" id="task_name" name="task_name" 
                                   value="Creaci√≥n de Proyecto" 
                                   placeholder="Nombre de la tarea a verificar">
                        </div>
                        
                        <div class="form-group">
                            <label for="proyecto_id">Proyecto (Opcional):</label>
                            <select class="form-control" id="proyecto_id" name="proyecto_id">
                                <option value="">-- Seleccionar Proyecto --</option>
                                {% for proyecto in proyectos %}
                                    <option value="{{ proyecto.id }}">{{ proyecto.nombre }} (ID: {{ proyecto.id }})</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Selecciona un proyecto para verificar sus datos espec√≠ficos
                            </small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-primary btn-block">
                                    üîç Verificar Datos
                                </button>
                            </div>
                            <div class="col-md-6">
                                <a href="{% url 'ejecutar_tarea_manual' %}" class="btn btn-info btn-block">
                                    üöÄ Ejecutar Tarea
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h6>‚ÑπÔ∏è Qu√© verifica esta herramienta</h6>
                </div>
                <div class="card-body">
                    <ul>
                        <li>üîç <strong>Variables del proceso:</strong> Verifica que las variables se guardaron correctamente</li>
                        <li>üèóÔ∏è <strong>Business Data Model:</strong> Confirma que los datos se persistieron en el BDM</li>
                        <li>üìã <strong>Estado de tareas:</strong> Muestra qu√© tareas est√°n disponibles y completadas</li>
                        <li>üìä <strong>Flujo del proceso:</strong> Verifica que el proceso avanz√≥ correctamente</li>
                        <li>‚úÖ <strong>Validaci√≥n completa:</strong> Resumen del estado general del proceso</li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-4">
                <a href="{% url 'consultar_datos_bonita' %}" class="btn btn-secondary">
                    üìä Consultar Datos Bonita
                </a>
                <a href="{% url 'home' %}" class="btn btn-secondary ml-2">
                    ‚Üê Volver al Inicio
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
